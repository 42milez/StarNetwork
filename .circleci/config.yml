version: 2
jobs:
  build:
    docker:
      - image: 42milez/cpp-dev-base:latest
    working_directory: /var/app
    environment:
      BUILD_DIR: &build_dir cmake-build-test
      BUILD_DIR_ASAN: &build_dir_asan cmake-build-test-asan
      BUILD_DIR_LSAN: &build_dir_lsan cmake-build-test-lsan
      BUILD_DIR_MSAN: &build_dir_msan cmake-build-test-msan
      BUILD_DIR_TSAN: &build_dir_tsan cmake-build-test-tsan
    steps:
      - checkout
      - restore_cache:
          key: build-{{ .Branch }}-{{ .Environment.CacheUUID }}
      - run:
          name: 'Create Build Directory'
          command: |
            mkdir -p "${BUILD_DIR}"
            mkdir -p "${BUILD_DIR_ASAN}"
            mkdir -p "${BUILD_DIR_LSAN}"
            mkdir -p "${BUILD_DIR_MSAN}"
            mkdir -p "${BUILD_DIR_TSAN}"
      - run:
          name: "Build All"
          command: /bin/bash ./docker/script/build/build_all.bash
          environment:
            BUILD_DIR: *build_dir
      - run:
          name: "Build All with Address Sanitizer"
          command: /bin/bash ./docker/script/build/build_all_asan.bash
          environment:
            BUILD_DIR: *build_dir_asan
      - run:
          name: "Build All with Leak Sanitizer"
          command: /bin/bash ./docker/script/build/build_all_lsan.bash
          environment:
            BUILD_DIR: *build_dir_lsan
      - run:
          name: "Build All with Memory Sanitizer"
          command: /bin/bash ./docker/script/build/build_all_msan.bash
          environment:
            BUILD_DIR: *build_dir_msan
      - run:
          name: "Build All with Thread Sanitizer"
          command: /bin/bash ./docker/script/build/build_all_tsan.bash
          environment:
            BUILD_DIR: *build_dir_tsan
      - save_cache:
          key: build-{{ .Branch }}-{{ .Environment.CacheUUID }}-{{ checksum "./cmake-build-test/CMakeCache.txt" }}
          paths:
            - /root/.conan
            - *build_dir
            - *build_dir_asan
            - *build_dir_lsan
            - *build_dir_msan
            - *build_dir_tsan
  test_base: &test_base
    docker:
      - image: 42milez/cpp-dev-base:latest
    working_directory: /var/app
    steps:
      - checkout
      - restore_cache:
          key: build-{{ .Branch }}-{{ .Environment.CacheUUID }}
      - run:
          name: "Create Test Results Directory"
          command: |
            mkdir ./test-results
      - run:
          name: "Enable JUnit Reporter"
          command: echo "export CATCH_REPORTER=junit" >> $BASH_ENV
      - run:
          name: "Run All Test"
          command: /bin/bash ./docker/script/test/run_all_tests.bash
      - store_test_results:
          path: /var/app/test-results
  test:
    <<: *test_base
    environment:
      BUILD_DIR: *build_dir
  test_asan:
    <<: *test_base
    environment:
      BUILD_DIR: *build_dir_asan
  test_lsan:
    <<: *test_base
    environment:
      BUILD_DIR: *build_dir_lsan
  test_msan:
    <<: *test_base
    environment:
      BUILD_DIR: *build_dir_msan
  test_tsan:
    <<: *test_base
    environment:
      BUILD_DIR: *build_dir_tsan
workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - test:
          requires:
            - build
      - test_asan:
          requires:
            - build
            - test
      - test_lsan:
          requires:
            - build
            - test
      - test_msan:
          requires:
            - build
            - test
      - test_tsan:
          requires:
            - build
            - test
