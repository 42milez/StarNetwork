version: 2
jobs:
  build:
    docker:
      - image: 42milez/alpine-cmake-clang:latest
    working_directory: /var/app
    steps:
      - restore_cache:
          keys:
            - "source-v1-{{ .Branch }}-{{ .Revision }}"
            - "source-v1-{{ .Branch }}-"
            - "source-v1-"
      - checkout
      - run:
          name: "Create Build Directory"
          command: |
            if [[ ! -e ./build ]]; then
              mkdir ./build
            fi
#      - run:
#          name: "Run E2E Test"
#          command: /bin/bash ./test/run_e2e_test.sh
      - run:
          name: "Run Unit Test"
          command: |
            cd /var/app/build || exit
            /usr/bin/cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_COMPILER=/usr/bin/clang -DCMAKE_CXX_COMPILER=/usr/bin/clang++ -G "CodeBlocks - Unix Makefiles" /var/app
            /usr/bin/cmake --build /var/app/build --target all -- -j 4
            /var/app/build/test/unit/lib/rudp/command/rudp_command_test -r xml -d yes --order lex -o /tmp/test-results
      store_test_results:
        path: /tmp/test-results
      - save_cache:
          key: "source-v1-{{ .Branch }}-{{ .Revision }}"
          paths:
            - ".git"
            - ".hunter"
            - "build"